{% extends 'myapp/base.html' %}
{% load static %}
{% load humanize %}
{% block body %}

        <div class="m-10 font-bold">Add Expense âž•</div>
        <form action="" method="post" class="shadow-lg m-10 rounded-xl">
                {% csrf_token %}
                <div class="form-container px-10 py-10 flex">

                    <div class="mx-10" >
                        <div class="mb-5">
                            <label >Expense Name</label>
                        </div>

                        <div class="border"> {{ expense_form.name }} </div>
                    </div>

                    <div class="mx-10">
                        <div class="mb-5">
                            <label >Amount</label>
                        </div>

                        <div class="border"> {{ expense_form.amount }} </div>
                    </div>

                    <div class="mx-10">
                        <div class="mb-5">
                            <label >Category</label>
                        </div>

                        <div class="border"> {{ expense_form.category }} </div>
                    </div>

            <!--        <div style="display:none;">
                        <input type="text" value="{{ user_id }}">
                    </div>
                 -->

                    <div class="mx-10 mt-8">
                         <button type="submit" class="bg-green-500 px-5 py-2 rounded-lg text-white font-bold">Add</button>
                    </div>

                </div>
        </form>

        <div class="mx-10">
        <div class=" font-bold mb-5">Expenses ðŸ’µ  </div>
        <div>
                 <table class="min-w-full border-collapse border border-gray-200 shadow-lg rounded-xl overflow-hidden">

                        <thead class="bg-green-500 text-white">
                            <tr>
                                <th class="px-6 py-3 text-left">Expense Name</th>
                                <th class="px-6 py-3 text-left">Amount</th>
                                <th class="px-6 py-3 text-left">Category</th>
                                <th class="px-6 py-3 text-left">Date</th>
                                <th class="px-6 py-3 text-left">Edit</th>
                                <th class="px-6 py-3 text-left">Delete</th>
                            </tr>
                        </thead>

                        <tbody>
                            {% for expense in expenses %}
                            <tr class="bg-white even:bg-gray-100 hover:bg-green-50 transition-colors">
                                <td class="px-6 py-4">{{ expense.name }}</td>
                                <td class="px-6 py-4">â‚¹{{ expense.amount|intcomma }}</td>
                                <td class="px-6 py-4">{{ expense.category }}</td>
                                <td class="px-6 py-4">{{ expense.date|naturalday }}</td>
                                <td class="px-6 py-4">
                                    <a href="{% url 'myapp:edit' expense.id %}">


                                    <img class="h-5" src="{% static 'myapp/images/edit.png' %}" alt="Edit">

                                    </a>
                                </td>
                                <td class="px-6 py-4">

                                    <span>

                                         <form method="POST" action="{% url 'myapp:delete' expense.id %}">
                                             {% csrf_token %}
                                              <button name="delete">
                                                    <img class="h-5" src="{% static 'myapp/images/delete.png' %}" alt="Delete">
                                              </button>

                                         </form>

                                    </span>

                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-gray-500">No expenses yet.</td>
                            </tr>
                            {% endfor %}
                        </tbody>

            </table>

         <span class="font-bold text-green-500">Total â‚¹

             {% if total_expenses.amount__sum %}
                 {{ total_expenses.amount__sum|intcomma }}
             {% else %}
                {{ 0 }}
             {% endif %}

         </span>

        </div>

    <!--    <div class="flex justify-center mt-6 space-x-2">
            {% for i in page_range %}
                <a href="?page={{ i }}"
                   class="px-3 py-1 rounded-md border border-gray-300
                          {% if i == current_page %}bg-green-500 text-white{% else %}bg-white text-gray-700 hover:bg-gray-100{% endif %}">
                   {{ i }}
                </a>
            {% endfor %}
        </div> -->
        </div>

        <div class="flex mt-5">

                <div class="w-1/4 shadow-lg ml-10 rounded-lg" >
                    <h1 class="ml-10 font-bold test-gray-500 ">Last 365 days</h1>
                    <h1 class="ml-10 my-5 text-xl text-green-500 font-bold">
                            â‚¹{{ yearly_sum.amount__sum|intcomma }}
                    </h1>
                </div>

            <div class="w-1/4 shadow-lg ml-10 rounded-lg" >

                    <h1 class="ml-10 font-bold test-gray-500 ">Last 30 days</h1>
                    <h1 class="ml-10 my-5 text-xl text-green-500 font-bold">
                            â‚¹{{ monthly_sum.amount__sum|intcomma }}
                    </h1>

            </div>

            <div class="w-1/4 shadow-lg ml-10 rounded-lg" >

                    <h1 class="ml-10 font-bold test-gray-500 ">Last 7 days</h1>
                    <h1 class="ml-10 my-5 text-xl text-green-500 font-bold">
                            â‚¹{{ week_sum.amount__sum|intcomma }}
                    </h1>

            </div>

            <div class="w-1/4 shadow-lg ml-10 rounded-lg mr-5" >

                    <h1 class="ml-10 font-bold test-gray-500 ">Today</h1>
                    <h1 class="ml-10 my-5 text-xl text-green-500 font-bold">
                            â‚¹{{ today_sum.amount__sum|intcomma }}
                    </h1>

            </div>

        </div>


        <div class="flex">

                <div class="w-1/2 shadow-lg m-10">

                        <div class="flex flex-wrap space-x-40 font-bold px-20 py-5">

                             <span>Past 30 days sum expenses</span>

                        </div>

                    <hr>
                        <div id="30-day-table" >

                                {% for daily_sum in daily_sums %}

                                        <div class="flex flex-wrap px-20 py-5">
                                            <span>
                                                  {{ daily_sum.date }}
                                            </span>
                                        </div>

                                        <div class="flex flex-wrap px-20 py-5">
                                              <span class="text-green-500">
                                                    â‚¹{{ daily_sum.sum | intcomma }}
                                              </span>
                                        </div>
                                {% empty %}

                                        <p class="px-6 py-4 text-center text-gray-500">No expenses yet</p>

                                {% endfor %}


                        </div>

                </div>

                        <div class="w-1/2 shadow-lg m-10">

                        <div class="flex flex-wrap space-x-40 font-bold px-20 py-5">

                             <span> categorical sum expenses</span>

                        </div>

                    <hr>
                        <div  id="cat-sum-table">

                                {% for categorical_sum in categorical_sums %}

                                        <div class="flex flex-wrap px-20 py-5">
                                            <span>
                                                  {{ categorical_sum.category }}
                                            </span>
                                        </div>

                                        <div class="flex flex-wrap px-20 py-5">
                                              <span class="text-green-500">
                                                    â‚¹{{ categorical_sum.sum | intcomma }}
                                              </span>
                                        </div>
                                {% empty %}

                                        <p class="px-6 py-4 text-center text-gray-500">No expenses yet</p>

                                {% endfor %}


                        </div>

                </div>

        </div>

        <!-- charts  -->

        <div class="flex">

            <div class="w-1/2 shadow-lg ml-10">

                    <h1 class="mg-10"> Past 30 days sum expenses</h1>

                    <canvas id="myChart1" class="mg-10"></canvas>

            </div>

             <div class="w-1/2 shadow-lg ml-10">

                    <h1 class="mg-10"> Expenses across category</h1>

                    <canvas id="myChart" class="mg-10"></canvas>


             </div>








        </div>



    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.0.2/dist/chart.min.js"></script>

    <script>

        const cats = []

        const cats_sum = []

        var ctx = document.getElementById('myChart').getContext('2d');

        const catSumDiv = document.getElementById('cat-sum-table').getElementsByTagName("div")

        for( let i = 0; i < catSumDiv.length ; i++){

            if(i % 2 == 0){

                cats.push(catSumDiv[i].innerText)

            }
            else{
                 cats_sum.push(catSumDiv[i].innerText.replace("â‚¹","").replaceAll(',',''))

            }

        }




        // second chart

        var myChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: cats,
                datasets: [{
                    label: 'Past 30 days expenses across category',
                    data: cats_sum,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });


        // first chart

        const dates = []
        const sums = []

        const dailySumDiv = document.getElementById('30-day-table').getElementsByTagName("div")
        for( let i = 0; i < dailySumDiv.length ; i++){

            if(i % 2 == 0){

                dates.push(dailySumDiv[i].innerText)

            }
            else{
                 sums.push(dailySumDiv[i].innerText.replace("â‚¹","").replaceAll(',',''))

            }

        }

        console.log(dates)
        console.log(sums)

        var ctx1 = document.getElementById('myChart1').getContext('2d');
            var myChart = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: dates.reverse(),
                datasets: [{
                    label: 'Past 30 days expenses',
                    data: sums.reverse(),
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

    </script>





{% endblock %}